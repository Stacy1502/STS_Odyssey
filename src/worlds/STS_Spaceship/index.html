<html>
  <head>
    <meta charset="utf-8">

    <title>STS: Odyssey - Spaceship</title>

    <!-- REQUIRED --------------------------------------------------------------------------------------------------------------->
    <!-- webrtc shim from https://webrtc.github.io/adapter/adapter-latest.js -->
    <script src="/global/js/libs/adapter-latest.js"></script>
    <script src='/global/js/libs/aframe-master.min.js'></script>
    <script src='/global/js/libs/networked-aframe.min.js'></script>
    <script src='/global/js/libs/naf-janus-adapter.min.js'></script>
    <script src='/global/js/libs/aframe-extras.animation-mixer.js'></script>
    <script src='/global/js/libs/aframe-extras.controls.min.js'></script>
    <script src='/global/js/libs/aframe-extras.pathfinding.min.js'></script>
    <script src='/global/js/libs/checkpoint.js'></script>
    <script src="/socket.io/socket.io.js"></script>

    <script src="/global/js/components/aframe-fps-counter-component.min.js"></script>
    <script src="/global/js/components/aframe-mirror.js"></script>

    <script src='/global/js/circles_client_bundle.min.js'></script>

    <link rel="stylesheet" href="/global/css/user-gesture.css">

    <!-- OUR COMPONENTS --------------------------------------------------------------------------------------------------------->
    <script src="components/weight_bar.js"></script>
    <script src="components/system_ready.js"></script>
    <script src="components/enter_launch_sequence.js"></script>
    <script src="components/fuel_button.js"></script>
    <script src="components/players_ready.js"></script>
    <script src="components/levers.js"></script>
    <script src="components/turn_dial.js"></script>
    <script src="components/break_tank.js"></script>

    </head>
    <body>

    <!-- REQUIRED --------------------------------------------------------------------------------------------------------------->
      <div id="user-gesture-overlay" >
        <div id="Permissions" class="overlay">
          <img class="logo" src="/global/assets/textures/logos/circles_logo.svg" alt="Circles logo" />
          
          <div class="suboverlay">
            <p class="title">Permissions</p>
                
            <div id="user-microphone-wrapper" class="grid2col">
                <span class="label">Microphone</span>
                <div class="onoffswitch">
                <input type="checkbox" name="onoffswitch_mic" class="onoffswitch-checkbox" id="switch_mic" autocomplete="off">
                <label class="onoffswitch-label" for="switch_mic">
                    <span class="onoffswitch-inner"></span>
                    <span class="onoffswitch-switch"></span>
                </label>
                </div>
            </div>

            <input id="user-gesture-enter" class="user-gesture-button" type="submit" value="Enter Circles">
            <input id="wardrobe-enter" class="user-gesture-button"  type="submit" value="Customize Avatar">
            <!-- loading gif from: https://www.behance.net/gallery/31234507/Open-source-Loading-GIF-Icons-Vol-1 -->
            <img id="loading-animation-enter" src="/global/images/loading.gif">
          </div>
        </div>
      </div>

      <div id="ui_wrapper">
          <input id="button_microphone" type="submit" value="">
      </div>

    <!-- REQUIRED -->
    <a-scene renderer="antialias: true;
                       colorManagement: true;
                       sortObjects: false;
                       foveationLevel: 3;
                       highRefreshRate: true;
                       physicallyCorrectLights: true;
                       logarithmicDepthBuffer: false;
                       precision: high;"
             networked-scene="room: __ROOM_NAME__;
                              connectOnLoad: true;
                              onConnect: onConnect;
                              audio: false;
                              debug: false;
                              adapter: socketio;
                              serverURL: /"
             shadow="autoUpdate:false; type:basic;"
             vr-mode-ui="enabled:true;"
             loading-screen="enabled:false;"
             device-orientation-permission-ui="enabled:true;"
             circles-enter-ui
             circles-platform-scene-shadows>
             

      <a-assets>
        <!-- OUR ASSETS --------------------------------------------------------------------------------------------------------->

        <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>
        <!-- ambient music/sound -->
        <a-entity circles-sound="type:music; src:./assets/K. Leimer - Very Tired.mp3; autoplay:true; loop:true;"></a-entity>

          <!-- IMAGES -->
          <img id="ui" src="./assets/images/ui.png" crossorigin="anonymous">
          <img id="sky" src="./assets/images/black stars.jpg">
          <img id="floor" src="./assets/images/floor.jpg">
          <img id="panel3" src=" ./assets/images/panel 3.png">
          <img id="panel1" src=" ./assets/images/panel 1.png">
          <img id="panel2" src=" ./assets/images/middle.png">
          <img id="panel4" src=" ./assets/images/dash.png">
          <img id="backwall" src="./assets/images/backwall.jpg">
          <img id="backwall" src="./assets/images/backwall.jpg">
          <img id="wall" src="./assets/images/wall1.jpg">
         
          <!-- 3D MODELS -->
          <a-asset-item id="Cockpit" response-type="arraybuffer" src="./assets/models/cockpit/version3.gltf"></a-asset-item>   

        <img id="task0GUI" src="assets/textures/task0GUI.png">
        <img id="task1GUI" src="assets/textures/task1GUI.png">
        <img id="task2GUI" src="assets/textures/task2GUI.png">
        <img id="task3GUI" src="assets/textures/task3GUI.png">
        <img id="task4GUI" src="assets/textures/task4GUI.png">
        <img id="task5GUI" src="assets/textures/task5GUI.png">
        <img id="task6GUI" src="assets/textures/task6GUI.png">
        <img id="task7GUI" src="assets/textures/task7GUI.png">
        <img id="task8GUI" src="assets/textures/task8GUI.png">
        <img id="task9GUI" src="assets/textures/task9GUI.png">
        <img id="task10GUI" src="assets/textures/task10GUI.png">
        <img id="task11GUI" src="assets/textures/task11GUI.png">

        <img id="prelaunchSuccessGUI" src="assets/textures/prelaunchSuccess.png">
        <img id="prelaunchFailGUI" src="assets/textures/prelaunchFail.png">
        <img id="missionSuccessGUI" src="assets/textures/missionComplete.png">
        <img id="missionFailGUI" src="assets/textures/missionFail.png">

        <!-- REQUIRED ----------------------------------------------------------------------------------------------------------->
        <template id="user-template">
          <a-entity>
            <a-entity class="avatar" 
                      position="0 __USER_HEIGHT__ 0"
                      circles-user-networked
                      circles-avatar-construction>

              <a-entity class="nametag_front avatar_node" text="align:center;" position="0 0.7 0" rotation="0 0 0" scale="3 3 3">
                <a-entity class="deviceicon_front" position="0 -0.06 0" geometry="primitive:plane; width:0.07; height:0.07;" material="shader:flat; transparent:true;"></a-entity>
              </a-entity>

              <a-entity class="nametag_back avatar_node" text="align:center;" position="0 0.7 0" rotation="0 180 0" scale="3 3 3">
                  <a-entity class="deviceicon_back" position="0 -0.06 0" geometry="primitive:plane; width:0.07; height:0.07;" material="shader:flat; transparent:true;"></a-entity>
              </a-entity>

              <a-entity class="user_head avatar_node"
                        networked-audio-source
                        gltf-model
                        circles-color
                        circles-shadow="cast:true; receive:true; applyToChildren:false;">

                <a-entity class="user_face_express"
                          geometry="primitive:plane; width:0.3; height:0.3;"
                          material="shader:flat; src:__FACE_MAP__; transparent:true; side:back; color:#000;"
                          position="0.0 0.0 -0.1">
                </a-entity>

                <a-entity class="user_hair"
                          gltf-model
                          circles-color
                          circles-shadow="cast:true; receive:true; applyToChildren:false;">
                </a-entity>
              </a-entity>

              <a-entity class="user_body avatar_node"
                        gltf-model
                        circles-color
                        circles-shadow="cast:true; receive:true; applyToChildren:false;"
                        position="0.0 -0.5 0.0">
              </a-entity>
            </a-entity>
          </a-entity>
        </template>

        <template id="interactive-object-template">
          <a-entity>
          </a-entity>
        </template>

        <template id="text-template">
          <a-entity>
          </a-entity>
        </template>
      </a-assets>

      <!-- WORLD GENERATION STARTS HERE ----------------------------------------------------------------------------------------->
      <a-entity id="circles-manager" circles-manager="world:__WORLDNAME__; user:__VISIBLENAME__"></a-entity>

      <!-- Avatar --> 
      <a-entity id="Player1"
                class="user_cam_rig"
                circles-add-camera-equipment="gui:true"
                networked="template:#user-template; attachTemplateToLocal:true;"
                circles-head-model="__MODEL_HEAD__"
                circles-hair-model="__MODEL_HAIR__"
                circles-body-model="__MODEL_BODY__"
                circles-head-color="__COLOR_HEAD__"
                circles-hair-color="__COLOR_HAIR__"
                circles-body-color="__COLOR_BODY__"
                circles-visiblename="__VISIBLENAME__"
                circles-usertype="__USERTYPE__">
      </a-entity>
<!-- 
      Ground
      <a-entity geometry="primitive: plane; width: 20; height: 20" 
                material="color: #000000" 
                position="" 
                rotation="-90 0 0">
      </a-entity>

      Sky and lights
      <a-entity id="sunlight" position="0 20 0" rotation="40 0 0" 
                light="type:directional; intensity:4; color:#d5e4f5; castShadow:false;"></a-entity>
      <a-entity light="type:hemisphere; color:#FFFFFF; groundColor:#BCE2F4; intensity:3.0"></a-entity>

      <a-entity id='skyBox'
                rotation='0 200 0'
                geometry='primitive:sphere; radius:50; segments-height:24; segments-width:24;'
                material='shader:flat; src:#skyMap; side:back;'>
      </a-entity> -->

      <!-- Starting game -->

         <!-- LIGHT -->
         <a-entity id="ambient" light="color: #eadac2; intensity: 0.420; type: ambient"></a-entity>

        <!-- MAIN ROOM -->
         <a-entity id="cockpit" gltf-model="#Cockpit" position="0 0.04057 0" rotation=""></a-entity>
     
         <!-- CHECKPOINTS -->

         <a-entity circles-checkpoint position="0.476 0 3.197"></a-entity>
         <a-entity circles-checkpoint position="1.242 0 -1.065" material="color: #005bf4;"></a-entity>
         <a-entity circles-checkpoint position="-0.547 0 -1.076" material="color: #005bf4;"></a-entity>

         <!-- NAVMESh -->
         <a-entity id="navmesh" gltf-model="./assets/models/navmesh.gltf"
          nav-mesh visible="false"></a-entity>

       <!-- BACKGROUND -->

        <a-entity light="color: #9eb1ff; intensity: 3.4; penumbra: 0.7; type: point" id="point" position="0 2.282 0"></a-entity>
        <a-entity light="color: #f09b56; intensity: 0.9; type: hemisphere" id="light"></a-entity>
        <a-entity geometry="primitive: plane" rotation="-90 0 0" material="src:#floor;" id="ground" scale="7.18939 8.86967 8.109" position="0 0  0.578"></a-entity>
        <a-sky animation="property: object3D.rotation.x; to: -360; loop: true; easing: linear; dur: 96000" id="#skydome" src="#sky"></a-sky>

        <!-- photo consoles -->
        <a-entity geometry="" position="0.21595 2.64001 -0.51494" scale="1.97742 0.07465 2.6487" rotation="" material="src: #panel1; color: #616161;" id="panel1-2"></a-entity>
        <a-entity geometry="" position="0.191 2.33052 -2.58551" scale="2.2227 0.07812 1.27871" rotation="-28.62611736032619 0 0" material="src: #panel3; color: #616161;" id="panel1"></a-entity>
        <a-entity geometry="" position="0.28228 0.64939 -1.34556" scale="0.62407 0.078 2.09625" rotation="9.38218389526723 0 0" material="src: #panel2; color: #616161;" id="panel1-3"></a-entity>

        <a-entity geometry="" position="0.318 1.48037 4.553" scale="7.07093 0.118 3.46484" rotation="90 90 90" material="src: #backwall;" id="panel1-4"></a-entity>

        <a-entity geometry="" position="-2.011 0.70655 -0.21468" scale="4.21103 0.01654 0.901" rotation="21.598217045251513 90.00021045914971 0" material="src: #panel4; color: #616161;" id="panel1-3"></a-entity>
        <a-entity geometry="" position="2.58599 0.707 -0.215" scale="4.211 0.017 0.901" rotation="-21 90 180" material="src: #panel4; color: #616161" id="panel1-5"></a-entity>
   
        <a-entity geometry="" position="3.20903 1.48037 2.19148" scale="7.07093 0.118 3.46484" rotation="90 0 90" material="src: #wall;  color: #969696" id="panel1-7"></a-entity>
        <a-entity geometry="" position="-3.04088 1.48037 2.26084" scale="7.07093 0.118 3.46484" rotation="90 0 90" material="src: #wall;  color: #969696" id="panel1-7"></a-entity>
   
        <!-- PORTAL -->
        <a-entity scale="0.7 0.7 0.7" position="1.957 0.908 3.234" id="Portal-Lobby" circles-portal="title_text: Back to Lobby; link_url: #"><a-entity class="portal interactive" material="src: /global/assets/textures/equirectangular/WhiteBlue.jpg; shader: flat" geometry="primitive: sphere; radius: 0.5; segmentsWidth: 10; segmentsHeight: 10" circles-interactive-object="type: outline; neutral_scale: 1.1; hover_scale: 1.15; click_scale: 1.15" scale="" circles-material-extend-fresnel="fresnelOpacity: 0" sound="volume: 0.5"><a-entity class="object_highlight" geometry="primitive: sphere; radius: 0.5; segmentsWidth: 10; segmentsHeight: 10" material="color: rgb(255,255,255); shader: flat; side: back" scale="1.1 1.1 1.1" shadow="cast: false; receive: false" visible=""></a-entity></a-entity><a-entity class="title" position="0 1 0" rotation="0 180 0" text="value: Back to Lobby; align: center; width: 5"></a-entity></a-entity>
 

      <!-- Player 3 button -->
      <a-entity geometry="depth:0.75; width:0.75; height:0.5" 
                position="-3 0.25 0" 
                material="color:#000000">
      </a-entity>
      <a-entity id="player3Ready"
                circles-button="button_color: #fb9d9d; diameter: 0.75; button_color_hover: #ff7575; pedastal_color: #000000" 
                position="-3 0.5 0">
      </a-entity>

      <!-- Player 4 button -->
      <a-entity geometry="depth:0.75; width:0.75; height:0.5" 
                position="3 0.25 0" 
                material="color:#000000">
      </a-entity>
      <a-entity id="player4Ready"
                circles-button="button_color: #fb9d9d; diameter: 0.75; button_color_hover: #ff7575; pedastal_color: #000000" 
                position="3 0.5 0">
      </a-entity>

      <a-entity players_ready id="startingGameManager" visible="true">

        <!-- Instructions -->
        <a-entity text="value:Each player press a ready\nbuttons to start the experience; 
                        align:center; color:#FFFFFF; lineHeight:60"
                  rotation="0 0 0" 
                  scale="4 4 4" 
                  position="0 3 -6.85">
        </a-entity>

        <a-entity text="value:Mission Control; 
                        align:center; color:#FFFFFF; lineHeight:60"
                  rotation="0 0 0" 
                  scale="4 4 4" 
                  position="-4.5 3.5 -6.85">
        </a-entity>

        <a-entity text="value:Spaceship; 
                        align:center; color:#FFFFFF; lineHeight:60"
                  rotation="0 0 0" 
                  scale="4 4 4" 
                  position="4.5 3.5 -6.85">
        </a-entity>

        <!-- Player Ready Texts -->
        <a-entity id="player1ReadyText"
                  text="value:Player 1 Ready; 
                        align:center; color:#4a4a4a; lineHeight:60"
                  rotation="0 0 0" 
                  scale="4 4 4" 
                  position="-4.5 3 -6.85">
        </a-entity>

        <a-entity id="player2ReadyText"
                  text="value:Player 2 Ready; 
                        align:center; color:#4a4a4a; lineHeight:60"
                  rotation="0 0 0" 
                  scale="4 4 4" 
                  position="-4.5 2.5 -6.85">
        </a-entity>

        <a-entity id="player3ReadyText"
                  text="value:Player 3 Ready; 
                        align:center; color:#4a4a4a; lineHeight:60"
                  rotation="0 0 0" 
                  scale="4 4 4" 
                  position="4.5 3 -6.85">
        </a-entity>

        <a-entity id="player4ReadyText"
                  text="value:Player 4 Ready; 
                        align:center; color:#4a4a4a; lineHeight:60"
                  rotation="0 0 0" 
                  scale="4 4 4" 
                  position="4.5 2.5 -6.85">
        </a-entity>

      </a-entity>

      <script>
        let startingSocket = io();

        startingSocket.on('connect', (userData) => 
        {
          var startingManager = document.querySelector('#startingGameManager');

          // Emitting if players 3 and 4 are ready or not every 100 milliseconds
          ready = setInterval(function() 
          {
            startingSocket.emit('player3Ready', {ready: startingManager.getAttribute('players_ready')['player3'], room:CIRCLES.getCirclesGroupName(), world:CIRCLES.getCirclesWorldName()});
            startingSocket.emit('player4Ready', {ready: startingManager.getAttribute('players_ready')['player4'], room:CIRCLES.getCirclesGroupName(), world:CIRCLES.getCirclesWorldName()});

          }, 100);

          // Listening for is players 1 and 2 are ready and updating their player ready texts accordingly
          startingSocket.on('player1Ready', (data) => 
          {
            if (data.ready === true)
            {
              document.querySelector('#player1ReadyText').setAttribute('text', {color: '#00FF00'});
            }
            else
            {
              document.querySelector('#player1ReadyText').setAttribute('text', {color: '#4a4a4a'});
            }
          });

          startingSocket.on('player2Ready', (data) => 
          {
            if (data.ready === true)
            {
              document.querySelector('#player2ReadyText').setAttribute('text', {color: '#00FF00'});
            }
            else
            {
              document.querySelector('#player2ReadyText').setAttribute('text', {color: '#4a4a4a'});
            }
          });

          // Listening for if all players are ready to start the game
          // If they are, begin the first task
          startingSocket.on('allPlayersReady', (data) => 
          {
            // So this is only executed once
            if (startingManager.getAttribute('visible') === true)
            {
              startingManager.setAttribute('visible', false);

              // Updating GUI to display current task
              document.querySelector('#guiOverlay').setAttribute('material', {src:'#task1GUI'});
            }
          });
        });
      </script>

      <!-- TASK 2: Check cargo weight and determine if itâ€™s too heavy -->

      <!-- TV -->

      <!-- Screen -->
      <a-entity id="weightScreen"
                geometry="primitive:plane; height:1.5; width:1.5" 
                rotation="0 90 0" 
                position="-7.9 2 0" 
                material="color:#e6e6e6">
      </a-entity>

      <!-- Weight Bar -->
      <a-entity id="weightBar"
                geometry="height:0; width:1.5; primitive:plane;" 
                rotation="0 90 0" 
                position="-7.895 1.25 0" 
                material="color:#9db0fb">
      </a-entity>

      <!-- Buttons -->

      <!-- Up -->
      <a-entity id="weightUp"
                circles-button="button_color: #04be29; diameter: 0.75; button_color_hover: #01931e; pedastal_color: #000000" 
                position="-8 2.5 -1.7"
                rotation="0 0 -90">
      </a-entity>

      <!-- Down -->
      <a-entity id="weightDown"
                circles-button="button_color: #be0404; diameter: 0.75; button_color_hover: #930101; pedastal_color: #000000" 
                position="-8 1.5 -1.7"
                rotation="0 0 -90">
      </a-entity>

      <!-- Base -->
      <a-entity id="task2Component"
                geometry="depth:2; height:2; width:0.15" 
                position="-8 2 0" 
                material="color:#000000"
                weight_bar>
      </a-entity>

      <!-- TASK 3: Engaging seatbelts and turning on system -->

      <!-- Player 1 button -->
      <a-entity geometry="depth:0.75; width:0.75; height:0.5" 
                position="3 0.25 -5" 
                material="color:#000000">
      </a-entity>
      <a-entity id="player1Button"
                circles-button="button_color: #fb9dcf; diameter: 0.75; button_color_hover: #ff75bf; pedastal_color: #000000" 
                position="3 0.5 -5">
      </a-entity>

      <!-- Player 2 button -->
      <a-entity geometry="depth:0.75; width:0.75; height:0.5" 
                position="-3 0.25 -5" 
                material="color:#000000">
      </a-entity>
      <a-entity id="player2Button"
                circles-button="button_color: #fb9dcf; diameter: 0.75; button_color_hover: #ff75bf; pedastal_color: #000000" 
                position="-3 0.5 -5">
      </a-entity>

      <!-- Screen -->
      <a-entity id="task3Component"
                system_ready
                geometry="depth:0.25; width:2" 
                rotation="-30 0 0" 
                material="color:#000000"
                position="0 1.5 -7">
      </a-entity>
      <a-entity id="player1Ready"
                geometry="primitive:plane; height:0.75; width:0.75" 
                rotation="-30 0 0" 
                position="0.46 1.56 -6.85"
                material="color:#FF0000">
      </a-entity>
      <a-entity id="player2Ready"
                geometry="primitive:plane; height:0.75; width:0.75" 
                rotation="-30 0 0" 
                position="-0.46 1.56 -6.85"
                material="color:#FF0000">
      </a-entity>

      <!-- TASK 4: The flight crew presses a button to request data, the mission control must read off a set of numbers for the crew to type in -->

      <!-- Button to request data -->
      <a-entity geometry="depth:0.75; width:0.75; height:1" 
                position="7 0.5 -1" 
                material="color:#000000">
      </a-entity>
      <a-entity id="dataRequest"
                circles-button="button_color: #9db9fb; diameter: 0.75; button_color_hover: #75a3ff; pedastal_color: #000000" 
                position="7 1 -1">
      </a-entity>

      <!-- Base -->
      <a-entity geometry="depth:3; height:2; width:0.15" 
                position="8 2 1" 
                material="color:#000000">
      </a-entity>

      <!-- Screen -->
      <a-entity geometry="primitive:plane; height:1.5; width:2.5" 
                rotation="0 -90 0" 
                position="7.9 2 1" 
                material="color:#e6e6e6">
      </a-entity>
      <a-entity text="value: ___   ___   ___   ___   ___   ___;
                      align:center; color:#000000; lineHeight:0.05;" 
                rotation="0 -90 0" 
                scale="4 4 4" 
                position="7.8 2.3 1">
      </a-entity>

      <!-- Instructions -->
      <a-entity id="dataRequestInstructions"
                text="value: Press the button to request \n the code from mission control; 
                      align:center; color:#000000; lineHeight:60" 
                rotation="0 -90 0" 
                scale="3 3 3" 
                position="7.8 1.76 1">
      </a-entity>

      <!-- Number pad -->
      <a-entity id="numberPad" visible="false">
        <!-- The child elements have to be in order from 0 to 9 (with the backspace last) or the user clicks on the number pad won't work correctly -->
        <a-entity id="pad">
          <!-- 0 -->
          <a-entity class="interactive"
                    geometry="primitive:plane; height:0.3; width:0.3" 
                    rotation="0 -90 0" 
                    position="7.8 1.9 0.1" 
                    material="color:#9db9fb">
          </a-entity>
          <!-- 1 -->
          <a-entity class="interactive"
                    geometry="primitive:plane; height:0.3; width:0.3" 
                    rotation="0 -90 0" 
                    position="7.8 1.9 0.45" 
                    material="color:#9db9fb">
          </a-entity>
          <!-- 2 -->
          <a-entity class="interactive"
                    geometry="primitive:plane; height:0.3; width:0.3" 
                    rotation="0 -90 0" 
                    position="7.8 1.9 0.8" 
                    material="color:#9db9fb">
          </a-entity>
          <!-- 3 -->
          <a-entity class="interactive"
                    geometry="primitive:plane; height:0.3; width:0.3" 
                    rotation="0 -90 0" 
                    position="7.8 1.9 1.15" 
                    material="color:#9db9fb">
          </a-entity>
          <!-- 4 -->
          <a-entity class="interactive"
                    geometry="primitive:plane; height:0.3; width:0.3" 
                    rotation="0 -90 0" 
                    position="7.8 1.9 1.5" 
                    material="color:#9db9fb">
          </a-entity>
          <!-- 5 -->
          <a-entity class="interactive"
                    geometry="primitive:plane; height:0.3; width:0.3" 
                    rotation="0 -90 0" 
                    position="7.8 1.55 0.1" 
                    material="color:#9db9fb">
          </a-entity>
          <!-- 6 -->
          <a-entity class="interactive"
                    geometry="primitive:plane; height:0.3; width:0.3" 
                    rotation="0 -90 0" 
                    position="7.8 1.55 0.45" 
                    material="color:#9db9fb">
          </a-entity>
          <!-- 7 -->
          <a-entity class="interactive"
                    geometry="primitive:plane; height:0.3; width:0.3" 
                    rotation="0 -90 0" 
                    position="7.8 1.55 0.8" 
                    material="color:#9db9fb">
          </a-entity>
          <!-- 8 -->
          <a-entity class="interactive"
                    geometry="primitive:plane; height:0.3; width:0.3" 
                    rotation="0 -90 0" 
                    position="7.8 1.55 1.15" 
                    material="color:#9db9fb">
          </a-entity>
          <!-- 9 -->
          <a-entity class="interactive"
                    geometry="primitive:plane; height:0.3; width:0.3" 
                    rotation="0 -90 0" 
                    position="7.8 1.55 1.5" 
                    material="color:#9db9fb">
          </a-entity>
          <!-- Backspace -->
          <a-entity class="interactive"
                    geometry="primitive:plane; height:0.3; width:0.3" 
                    rotation="0 -90 0" 
                    position="7.8 1.745 1.9" 
                    material="color:#75a3ff">
          </a-entity>
        </a-entity>
        <a-entity id="numbers">
          <a-entity text="value:0;
                          align:center; color:#000000; lineHeight:0.05;" 
                    rotation="0 -90 0" 
                    scale="3 3 3" 
                    position="7.78 1.9 0.1">
          </a-entity>
          <a-entity text="value:1;
                          align:center; color:#000000; lineHeight:0.05;" 
                    rotation="0 -90 0" 
                    scale="3 3 3" 
                    position="7.78 1.9 0.45">
          </a-entity>
          <a-entity text="value:2;
                          align:center; color:#000000; lineHeight:0.05;" 
                    rotation="0 -90 0" 
                    scale="3 3 3" 
                    position="7.78 1.9 0.8">
          </a-entity>
          <a-entity text="value:3;
                          align:center; color:#000000; lineHeight:0.05;" 
                    rotation="0 -90 0" 
                    scale="3 3 3" 
                    position="7.78 1.9 1.15">
          </a-entity>
          <a-entity text="value:4;
                          align:center; color:#000000; lineHeight:0.05;" 
                    rotation="0 -90 0" 
                    scale="3 3 3" 
                    position="7.78 1.9 1.5">
          </a-entity>
          <a-entity text="value:5;
                          align:center; color:#000000; lineHeight:0.05;" 
                    rotation="0 -90 0" 
                    scale="3 3 3" 
                    position="7.78 1.55 0.1">
          </a-entity>
          <a-entity text="value:6;
                          align:center; color:#000000; lineHeight:0.05;" 
                    rotation="0 -90 0" 
                    scale="3 3 3" 
                    position="7.78 1.55 0.45">
          </a-entity>
          <a-entity text="value:7;
                         align:center; color:#000000; lineHeight:0.05;" 
                    rotation="0 -90 0" 
                    scale="3 3 3" 
                    position="7.78 1.55 0.8">
          </a-entity>
          <a-entity text="value:8;
                          align:center; color:#000000; lineHeight:0.05;" 
                    rotation="0 -90 0" 
                    scale="3 3 3" 
                    position="7.78 1.55 1.15">
          </a-entity>
          <a-entity text="value:9;
                          align:center; color:#000000; lineHeight:0.05;" 
                    rotation="0 -90 0" 
                    scale="3 3 3" 
                    position="7.78 1.55 1.5">
          </a-entity>
          <a-entity text="value:X;
                      align:center; color:#000000; lineHeight:0.05;" 
                    rotation="0 -90 0" 
                    scale="3 3 3" 
                    position="7.8 1.745 1.9">
          </a-entity>
        </a-entity>
      </a-entity>

      <!-- Text for code -->
      <!-- The order of the children matter and need to be from left to right or the display of the sequence will not display correctly -->
      <a-entity id="code" enter_launch_sequence>
        <a-entity text="value:;
                      align:center; color:#000000; lineHeight:0.05;" 
                rotation="0 -90 0" 
                scale="4 4 4" 
                position="7.8 2.4 0.07">
        </a-entity>
        <a-entity text="value:;
                      align:center; color:#000000; lineHeight:0.05;" 
                rotation="0 -90 0" 
                scale="4 4 4" 
                position="7.8 2.4 0.445">
        </a-entity>
        <a-entity text="value:;
                      align:center; color:#000000; lineHeight:0.05;" 
                rotation="0 -90 0" 
                scale="4 4 4" 
                position="7.8 2.4 0.805">
        </a-entity>
        <a-entity text="value:;
                      align:center; color:#000000; lineHeight:0.05;" 
                rotation="0 -90 0" 
                scale="4 4 4" 
                position="7.8 2.4 1.176">
        </a-entity>
        <a-entity text="value:;
                      align:center; color:#000000; lineHeight:0.05;" 
                rotation="0 -90 0" 
                scale="4 4 4" 
                position="7.8 2.4 1.542">
        </a-entity>
        <a-entity text="value:;
                      align:center; color:#000000; lineHeight:0.05;" 
                rotation="0 -90 0" 
                scale="4 4 4" 
                position="7.8 2.4 1.91">
        </a-entity>
      </a-entity>

      <script>
        let task4Socket = io();

        task4Socket.on('connect', (userData) => 
        {
            // Checking if task 3 is complete
            // If it is, emit it and updated GUI
            task3Check = setInterval(function()
            {
                if (document.querySelector('#task3Component').getAttribute('system_ready')['ready'] === true)
                {
                  taskManager.emit('task3Complete', {room:CIRCLES.getCirclesGroupName(), world:CIRCLES.getCirclesWorldName()});
                  clearInterval(task3Check);

                  // Updating GUI to display current task
                  document.querySelector('#guiOverlay').setAttribute('material', {src:'#task4GUI'});
                }

            }, 1000);

            // Listening for the data request button click and emit it when it is
            document.querySelector('#dataRequest').addEventListener('click', function()
            {
              // Only running if task 3 is complete (checking spot_the_difference component)
              if (document.querySelector('#task3Component').getAttribute('system_ready')['ready'] === true)
              {
                document.querySelector('#code').setAttribute('enter_launch_sequence', {isPrevComplete: true});

                task4Socket.emit('dataRequest', {room:CIRCLES.getCirclesGroupName(), world:CIRCLES.getCirclesWorldName()});

                // Hiding the data request instructions
                document.querySelector('#dataRequestInstructions').setAttribute('visible', false);

                // Make number pad visible
                document.querySelector('#numberPad').setAttribute('visible', true);
                }
            });

            // Listening for the launch sequence
            // Storing the the sequence to compare to the launch sequence the flight crew enters
            task4Socket.on('launchSequence', (data) => 
            {
              document.querySelector('#code').setAttribute('enter_launch_sequence', {sequence: data.sequence});
            });
        });
      </script>

      <!-- TASK 5: Flight crew must fill up gas tank to an amount only visible to mission control -->

      <!-- Base -->
      <a-entity geometry="depth:2; height:2.5; width:0.15" 
                position="0 2 7" 
                rotation="0 90 0"
                material="color:#000000">
      </a-entity>

      <!-- Fuel tank background -->
      <a-entity geometry="primitive:plane; height:1.3" 
                position="0 1.8 6.9" 
                rotation="0 180 0"
                material="color:#FFFFFF">
      </a-entity>
      <a-entity geometry="primitive:plane; width:0.5; height:0.5" 
                position="0 2.6 6.9" 
                rotation="0 180 0"
                material="color:#FFFFFF">
      </a-entity>

      <!-- Fuel tank -->
      <a-entity id="fuelTank"
                geometry="width:0.75; height:1; primitive:plane" 
                position="0 1.8 6.89" 
                rotation="0 180 0"
                material="color:#d9d9d9">
      </a-entity>

      <!-- Fuel bar -->
      <a-entity id="fuelBar"
                geometry="width:0.75; height:0; primitive:plane" 
                position="0 1.3 6.88" 
                rotation="0 180 0"
                material="color:#FFDD00">
      </a-entity>

      <!-- Button -->
      <a-entity id="fuelButton"
                fuel_button
                circles-button="button_color: #04be29; diameter: 0.75; button_color_hover: #01931e; pedastal_color: #000000" 
                position="-1.6 2 7"
                rotation="-90 0 0">
      </a-entity>

      <script>
        let task5Socket = io();

        task5Socket.on('connect', (userData) => 
        {
            // Emitting the fuel bar height every 30 milliseconds
            setInterval(function() 
            {
              task5Socket.emit('fuelBarHeight', {height: document.querySelector('#fuelBar').getAttribute('geometry')['height'], room:CIRCLES.getCirclesGroupName(), world:CIRCLES.getCirclesWorldName()});

            }, 30);

            // Listening for when the fuel bar has reached the ideal height
            task5Socket.on('idealFuelReached', (data) =>
            {
              fuelBar = document.querySelector('#fuelBar');

              // Updating that the ideal height has been reached in the component that deals with the fuel bar
              document.querySelector('#fuelButton').setAttribute('fuel_button', {isIdeal: true});

              // Updating color of fuel bar to indicate ideal amount is reached
              fuelBar.setAttribute('material', {color: '#00FF00'});

              // Updating the fuel bar height to be exactly the ideal amount
              fuelBar.setAttribute('geometry', {height: data.idealAmount});

              // Updating fuel bar position to level it out
              fuelBar.setAttribute('position', {
                x: fuelBar.getAttribute('position')['x'],
                y: 1.3 + (data.idealAmount / 2),
                z: fuelBar.getAttribute('position')['z']
              });
            });
        });
      </script>

      <!-- TASK 7: Place a row of levers into the right order of up/down -->

      <!-- Screen -->
      <a-entity geometry="depth:0.18; height:2.5; width:4" 
                position="4.5 3 -7" 
                material="color:#000000">
      </a-entity>
      
      <!-- Lever display on screen -->
      <!-- Position -->
      <a-entity id="positionScreen"
                geometry="primitive:plane; height:0.25; width:3" 
                position="4.5 3.5 -6.85"
                material="color: #FFFFFF">
      </a-entity>
      <a-entity text="value:Position; 
                      align:left; color:#FFFFFF; lineHeight:60"
                rotation="0 0 0" 
                scale="3 3 3" 
                position="4.47 3.7 -6.85">
      </a-entity>
      <a-entity id="positionBar"
                geometry="primitive:plane; height:0.25; width:0" 
                material="color: #FFDD00" 
                position="3 3.5 -6.845">
      </a-entity>

      <!-- Velocity -->
      <a-entity id="velocityScreen"
                geometry="primitive:plane; height:0.25; width:3" 
                material="color: #FFFFFF" 
                position="4.5 2.95 -6.85">
      </a-entity>
      <a-entity text="value:Velocity; 
                      align:left; color:#FFFFFF; lineHeight:60"
                rotation="0 0 0" 
                scale="3 3 3" 
                position="4.47 3.15 -6.85">
      </a-entity>
      <a-entity id="velocityBar"
                geometry="primitive:plane; height:0.25; width:0" 
                material="color: #FFDD00" 
                position="3 2.95 -6.845">
      </a-entity>

      <!-- Altitude -->
      <a-entity id="altitudeScreen"
                geometry="height:0.25; width:3; primitive:plane" 
                material="color: #FFFFFF" 
                position="4.5 2.4 -6.85">
      </a-entity>
      <a-entity text="value:Altitude; 
                      align:left; color:#FFFFFF; lineHeight:60"
                rotation="0 0 0" 
                scale="3 3 3" 
                position="4.47 2.6 -6.85">
      </a-entity>
      <a-entity id="altitudeBar"
                geometry="primitive:plane; height:0.25; width:0" 
                material="color: #FFDD00" 
                position="3 2.4 -6.845">
      </a-entity>

      <!-- Buttons -->

      <!-- Top -->
      <a-entity id="topLeft"
                circles-button="button_color: #be0404; diameter: 0.75; button_color_hover: #930101; pedastal_color: #bababa" 
                position="-0.2 0.4 -2.9"
                scale="0.75 0.75 0.75">
      </a-entity>
      <a-entity id="topRight"
                circles-button="button_color: #04be29; diameter: 0.75; button_color_hover: #01931e; pedastal_color: #bababa" 
                position="0.2 0.4 -2.9"
                scale="0.75 0.75 0.75">
      </a-entity>

      <!-- Middle -->
      <a-entity id="middleLeft"
                circles-button="button_color: #be0404; diameter: 0.75; button_color_hover: #930101; pedastal_color: #bababa" 
                position="-0.2 0.4 -2.475"
                scale="0.75 0.75 0.75">
      </a-entity>
      <a-entity id="middleRight"
                circles-button="button_color: #04be29; diameter: 0.75; button_color_hover: #01931e; pedastal_color: #bababa" 
                position="0.2 0.4 -2.475"
                scale="0.75 0.75 0.75">
      </a-entity>

      <!-- Bottom -->
      <a-entity id="bottomLeft"
                circles-button="button_color: #be0404; diameter: 0.75; button_color_hover: #930101; pedastal_color: #bababa" 
                position="-0.2 0.4 -2.05"
                scale="0.75 0.75 0.75">
      </a-entity>
      <a-entity id="bottomRight"
                circles-button="button_color: #04be29; diameter: 0.75; button_color_hover: #01931e; pedastal_color: #bababa" 
                position="0.2 0.4 -2.05"
                scale="0.75 0.75 0.75">
      </a-entity>

      <!-- Base -->
      <a-entity id="task7Component"
                geometry="depth: 1.5; height: 0.5" 
                position="0 0.25 -2.5" 
                material="color: #bababa"
                levers>
      </a-entity>

      <!-- Task 9: Aligning the display towards the sun-->

      <!-- Screen -->
      <a-entity geometry="primitive: circle; radius: 0.7" 
                rotation="-90 0 0" 
                material="" 
                position="-5 0.751 3">
      </a-entity>

      <!-- Button -->
      <a-entity id="spin"
                circles-button="button_color: #fbff00; diameter: 0.75; button_color_hover: #bdb600; pedastal_color: #FFFFFF" 
                position="-5 0.7 3"
                scale="0.5 0.5 0.5">
      </a-entity>

      <a-entity id="alignmentContainer" position="-5 0.752 3" visible="false">
        <a-entity geometry="primitive: triangle; vertexA: 0 0.25 0; vertexB: -0.1 -0.25 0; vertexC: 0.1 -0.25 0" 
                  rotation="-90 -90 0" 
                  material="color: #fbff00" 
                  position="-0.25 0 0">
        </a-entity>
      </a-entity>

      <!-- Dial -->
      <a-entity id="dialContainer" position="-5 0.753 3">
        <a-entity id="task9Component"
                  geometry="primitive: plane; height: 0.025; width: 0.5" 
                  rotation="-90 0 0" 
                  material="color: #000000" 
                  position="-0.25 0 0"
                  turn_dial>
        </a-entity>
      </a-entity>

      <!-- Base -->
      <a-entity geometry="primitive: box; width: 1.5; height: 0.75; depth: 1.5" 
                material="color: #000000" 
                position="-5 0.375 3" 
                rotation="0 0 0">
      </a-entity>

      <script>
        let task9Socket = io();

        task9Socket.on('connect', (userData) => 
        {
            // Emitting the dial rotation every 5 milliseconds
            setInterval(function() 
            {
              task9Socket.emit('dialRotation', {rotation: document.querySelector('#dialContainer').getAttribute('rotation')['y'], room:CIRCLES.getCirclesGroupName(), world:CIRCLES.getCirclesWorldName()});

            }, 5);

            // Listening for when the dial is aligned
            // When it is, show the alignment and highlght it and the button green
            task9Socket.on('aligned', (data) =>
            {
              // Getting alignment indicator
              var alignmentContainer = document.querySelector('#alignmentContainer');
              var alignment = alignmentContainer.children[0];
              
              // Getting button that confirms alignment
              var button = document.querySelector('#spin');

              // Rotating alignment to the correct position
              alignmentContainer.setAttribute('rotation', {y: data.alignment});

              // Displaying alignment
              alignmentContainer.setAttribute('visible', true);

              // Changing buttons and alignment colour to green to indicate the task is complete
              alignment.setAttribute('material', {color: '#00FF00'});
              button.setAttribute('circles-button', {button_color: '#00FF00', button_color_hover: '#00FF00'});

              // Changing component turn_dial attribute to show that the task is complete
              document.querySelector('#dialContainer').children[0].setAttribute('turn_dial', {isAligned: true});

            });
        });
      </script>

      <!-- Task 10: Break off the external fuel tank from the ship -->
      <a-entity text="value: Break off\nexternal fuel\ntank; 
                      align: center; color: #FFFFFF; lineHeight: 60" 
                rotation="0.01 0 0" 
                scale="2 2 2" 
                position="0 0.8 -4.6">
      </a-entity>
      <a-entity geometry="depth:0.75; width:0.75" 
                position="0 0.5 -5" 
                material="color:#000000">
      </a-entity>
      <a-entity id="task10Component"
                break_tank
                circles-button="button_color: #9dfba8; diameter: 0.75; button_color_hover: #9aff75; pedastal_color: #000000" 
                position="0 1 -5">
      </a-entity>

      <!-- Controlling execution of tasks -->
      <script>
        let taskManager = io();

        taskManager.on('connect', (userData) => 
        {
          // Listening for the timer value to update it
          taskManager.on('timerValue', (data) => 
          {
            document.querySelector('#timer').setAttribute('text', {value: data.time});
          });

          // Listening for if the prelaunch tasks were a success and updating GUI accordingly
          taskManager.on('prelaunchSuccess', (data) => 
          {
            document.querySelector('#guiOverlay').setAttribute('material', {src:'#prelaunchSuccessGUI'});
          });

          // Listening for if the prelaunch tasks were failed and updating GUI accordingly
          taskManager.on('prelaunchFail', (data) => 
          {
            document.querySelector('#guiOverlay').setAttribute('material', {src:'#prelaunchFailGUI'});

            // Turning off all tasks
            document.querySelector('#task2Component').setAttribute('weight_bar', {isPrevComplete: false});
            document.querySelector('#task3Component').setAttribute('system_ready', {isPrevComplete: false});
            document.querySelector('#code').setAttribute('enter_launch_sequence', {isPrevComplete: false});
            document.querySelector('#fuelButton').setAttribute('fuel_button', {isPrevComplete: false});
            ///////// CHANGE BUTTONS COLOURS BACK
            ///////// TURN TASKS SCREENS OFF

            // Display portal to lobby
            
          });

          // Listening for if the postlaunch tasks were a success and updating GUI accordingly
          taskManager.on('postlaunchSuccess', (data) => 
          {
            document.querySelector('#guiOverlay').setAttribute('material', {src:'#missionSuccessGUI'});

            // Opening lobby portal in 5 seconds
            setTimeout(function () 
                {
                  // Hiding all tasks
                  

                  // Display portal to lobby
                  

                }, 5000);
          });

          // Listening for if the postlaunch tasks were failed and updating GUI accordingly
          taskManager.on('postlaunchFail', (data) => 
          {
            document.querySelector('#guiOverlay').setAttribute('material', {src:'#missionFailGUI'});

            // Turning off all tasks
            document.querySelector('#task7Component').setAttribute('levers', {isPrevComplete: false});
            document.querySelector('#task9Component').setAttribute('turn_dial', {isPrevComplete: false});
            document.querySelector('#task10Component').setAttribute('break_tank', {isPrevComplete: false});
            ///////// CHANGE BUTTONS COLOURS BACK
            ///////// TURN TASKS SCREENS OFF

            // Display portal to lobby
            
          });

          // Listening for task 1 to be complete to begin task 2
          taskManager.on('task1Complete', (data) => 
          {
            // Updating GUI to display current task
            document.querySelector('#guiOverlay').setAttribute('material', {src:'#task2GUI'});

            document.querySelector('#task2Component').setAttribute('weight_bar', {isPrevComplete: true});
          });

          // Checking if task 2 is complete
          // If it is, begin task 3
          task2Check = setInterval(function()
          {
              if (document.querySelector('#task2Component').getAttribute('weight_bar')['isGood'] === true)
              {
                // Updating GUI to display current task
                document.querySelector('#guiOverlay').setAttribute('material', {src:'#task3GUI'});

                taskManager.emit('task2Complete', {room:CIRCLES.getCirclesGroupName(), world:CIRCLES.getCirclesWorldName()});

                document.querySelector('#task3Component').setAttribute('system_ready', {isPrevComplete: true});
                clearInterval(task2Check);

                // TASK 4 STARTED FROM task4Socket

                // Checking if task 4 is complete
                // If it is, begin task 5
                task4Check = setInterval(function()
                {
                    if (document.querySelector('#code').getAttribute('enter_launch_sequence')['isMatch'] === true)
                    {
                      // Updating GUI to display current task
                      document.querySelector('#guiOverlay').setAttribute('material', {src:'#task5GUI'});

                      document.querySelector('#fuelButton').setAttribute('fuel_button', {isPrevComplete: true});
                      taskManager.emit('task4Complete', {room:CIRCLES.getCirclesGroupName(), world:CIRCLES.getCirclesWorldName()});
                      clearInterval(task4Check);

                      // Checking if task 5 is complete
                      // If it is, emit it so task 6 can begin in mission control
                      task5Check = setInterval(function()
                      {
                          if (document.querySelector('#fuelButton').getAttribute('fuel_button')['isIdeal'] === true)
                          {
                            // Updating GUI to display current task
                            document.querySelector('#guiOverlay').setAttribute('material', {src:'#task6GUI'});

                            taskManager.emit('task5Complete', {room:CIRCLES.getCirclesGroupName(), world:CIRCLES.getCirclesWorldName()});
                            clearInterval(task5Check);
                          }

                      }, 1000);
                    }

                }, 1000);

              }

          }, 1000);

          // Listening for task 6 to be complete to begin task 7
          taskManager.on('task6Complete', (data) => 
          {
            // Updating GUI to display current task
            document.querySelector('#guiOverlay').setAttribute('material', {src:'#task7GUI'});

            document.querySelector('#task7Component').setAttribute('levers', {isPrevComplete: true});
          });

          // Checking if task 7 is complete
          // If it is, emit it so task 8 can begin in mission control
          task7Check = setInterval(function()
          {
              if (document.querySelector('#task7Component').getAttribute('levers')['isGood'] === true)
              {
                // Updating GUI to display current task
                document.querySelector('#guiOverlay').setAttribute('material', {src:'#task8GUI'});

                taskManager.emit('task7Complete', {room:CIRCLES.getCirclesGroupName(), world:CIRCLES.getCirclesWorldName()});
                clearInterval(task7Check);
              }

          }, 1000);

          // Listening for task 8 to be complete to begin task 9
          taskManager.on('task8Complete', (data) => 
          {
            // Updating GUI to display current task
            document.querySelector('#guiOverlay').setAttribute('material', {src:'#task9GUI'});

            document.querySelector('#task9Component').setAttribute('turn_dial', {isPrevComplete: true});
          });

          // Checking if task 9 is complete
          // If it is, begin task 10
          task9Check = setInterval(function()
          {
              if (document.querySelector('#task9Component').getAttribute('turn_dial')['isAligned'] === true)
              {
                // Updating GUI to display current task
                document.querySelector('#guiOverlay').setAttribute('material', {src:'#task10GUI'});

                taskManager.emit('task9Complete', {room:CIRCLES.getCirclesGroupName(), world:CIRCLES.getCirclesWorldName()});

                document.querySelector('#task10Component').setAttribute('break_tank', {isPrevComplete: true});

                clearInterval(task9Check);
              }

          }, 1000);

          // Checking if task 10 is complete
          // If it is, emit it so task 11 can begin in mission control
          task10Check = setInterval(function()
          {
              if (document.querySelector('#task10Component').getAttribute('break_tank')['isBrokenOff'] === true)
              {
                // Updating GUI to display current task
                document.querySelector('#guiOverlay').setAttribute('material', {src:'#task11GUI'});

                taskManager.emit('task10Complete', {room:CIRCLES.getCirclesGroupName(), world:CIRCLES.getCirclesWorldName()});
                clearInterval(task10Check);
              }

          }, 1000);

        });
      </script>

    </a-scene>

    <!-- WORLD GENERATION END HERE -------------------------------------------------------------------------------------------->

    <!-- REQUIRED ------------------------------------------------------------------------------------------------------------->
    <script>
      // Prompt for audio.
      if (CIRCLES.CONSTANTS.CIRCLES_WEBRTC_ENABLED && CIRCLES.CONSTANTS.CIRCLES_MIC_ENABLED) {
        document.addEventListener('DOMContentLoaded', () => {
          console.log('DOMContentLoaded');
          const scene = document.querySelector('a-scene');
          scene.addEventListener('adapter-ready', ({ detail: adapter }) => {
            console.log('adapter-ready');
            const clientId = CIRCLES.getUUID(); // generate a random 16 characters string, but you can use a uuid4 for example
            adapter.setClientId(clientId);
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
              adapter.setLocalMediaStream(stream).then(() => {
                // Note that networked-scene audio:true option has no effect with the janus adapter
                NAF.connection.adapter.enableMicrophone(false); // set it to false if you want to be muted initially.
              });
            }).catch(err => {
              console.warn("Microphone access not allowed. This client will not broadcast audio.");
            });
          });
        });
      }
      else {
        //disable HTML mic elements
        document.querySelector('#button_microphone').style.display = 'none';
        document.querySelector('#user-microphone-wrapper').style.display = 'none';
      }

      //naf schemas
      NAF.schemas.add({
        template: '#user-template',
        components: [
          'position',
          'rotation',
          {
            selector: '.user_cam_rig',
            component: 'position',
          },
          {
            selector: '.user_cam_rig',
            component: 'rotation',
          },
          {
            selector: '.avatar',
            component: 'position',
          },
          {
            selector: '.avatar',
            component: 'rotation',
          },
          {
            selector: '.nametag_front',
            component: 'visible',
          },
          {
            selector: '.nametag_front',
            component: 'position',
          },
          {
            selector: '.nametag_front',
            component: 'scale',
          },
          {
            selector: '.deviceicon_front',
            component: 'material',
          },
          {
            selector: '.deviceicon_back',
            component: 'material',
          },
          {
            selector: '.deviceicon_front',
            component: 'position',
          },
          {
            selector: '.deviceicon_back',
            component: 'position',
          },
          {
            selector: '.avatar',
            component: 'circles-user-networked',
          },
          {
            selector: '.nametag_back',
            component: 'visible',
          },
          {
            selector: '.nametag_back',
            component: 'position',
          },
          {
            selector: '.nametag_back',
            component: 'scale',
          },
          {
            selector: '.nametag_back',
            component: 'rotation',
          },
          {
            selector: '.user_head',
            component: 'visible',
          },
          {
            selector: '.user_head',
            component: 'position',
          },
          {
            selector: '.user_head',
            component: 'rotation',
          },
          {
            selector: '.user_body',
            component: 'visible',
          },
          {
            selector: '.user_body',
            component: 'position',
          },
          // {
          //   selector: '.user_body',
          //   component: 'rotation',
          // },
          {
            selector: '.user_face_express',
            component: 'position',
          },
        ]
      });

      NAF.schemas.add({
        template: '#interactive-object-template',
        components: [
          'position',
          'rotation',
          'scale',
          'gltf-model',
          'geometry',
          'material',
          'obj-model',
          //'circles-object-world',
          //'circles-interactive-object',
          //'circles-interactive-visible',
          //'circles-inspect-object',
          'shadow',
          //'class'
          // {
          //   selector: '.interactive',
          //   component: 'gltf-model',
          // },
        ]
      });

      NAF.schemas.add({
        template: '#text-template',
        components: [
          'position',
          'rotation',
          'scale',
          'text',
          'material'
        ]
      });

      // Called by Networked-Aframe when connected to server
      function onConnect () {
        console.log("custom onConnect: ", new Date());

        CIRCLES.setupCirclesWebsocket();

        //depending on scene loaded results in the mic button not working if clicked too fast
        //it also means the mic button has no effect (when 'adapter-ready' fires the mic also cannot be enabled/diabled) ...
        //I am not sure this is the best way to do this; but audio feedback is even worse ...
        document.querySelector('#loading-animation-enter').style.display='none';
        document.querySelectorAll('.user-gesture-button').forEach((elem)=> {
          //if entering the wardrobe world no need to show "enter wardrobe button"
          if (window.location.pathname.match(/wardrobe/i)) {
            if (elem.id !== 'wardrobe-enter') {
              elem.style.display='block';
            }
          }
          else {
            elem.style.display='block';
          }
        });

        //need to re-direct to wardrobe world if the user isn't "dressed" yet
        //make sure we add all urlParams together from provided link and existing url bar
        //const queryString = ((window.location.search) ? window.location.search + '&' : '?') + ((urlArr.length > 1) ? urlArr[1] : window.location.search);

        //we want to know if we have visited a world already during this session ...
        //const urlParams = new URLSearchParams(queryString);
        //urlParams.append('last_route', window.location.pathname);
        // if (!urlParams.has('last_route')) {
        //   urlParams.append('last_visited', '1');
        // }
        
        //mic sometimes is on for some reason
        if (CIRCLES.CONSTANTS.CIRCLES_WEBRTC_ENABLED && CIRCLES.CONSTANTS.CIRCLES_MIC_ENABLED) {
          NAF.connection.adapter.enableMicrophone(false);
        }
      }
    </script>
  </body>
</html>
